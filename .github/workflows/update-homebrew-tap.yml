name: Update Homebrew Tap

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.2)'
        required: true
      x86_64_sha256:
        description: 'SHA256 for x86_64 macOS binary'
        required: true
      aarch64_sha256:
        description: 'SHA256 for ARM64 macOS binary'
        required: true

jobs:
  update-tap:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v6
        with:
          repository: MikAoJk/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        run: |
          cd homebrew-tap
          FORMULA_FILE="Formula/git-profiles-cli.rb"
          
          # Update version
          sed -i "s/version \".*\"/version \"${{ github.event.inputs.version }}\"/" $FORMULA_FILE
          
          # Update x86_64 URL and SHA256
          sed -i "s|url \"https://github.com/MikAoJk/git-profiles-cli/releases/download/v.*/git-profiles-cli-.*-x86_64-apple-darwin.tar.gz\"|url \"https://github.com/MikAoJk/git-profiles-cli/releases/download/v${{ github.event.inputs.version }}/git-profiles-cli-${{ github.event.inputs.version }}-x86_64-apple-darwin.tar.gz\"|" $FORMULA_FILE
          
          # Update ARM64 URL and SHA256
          sed -i "s|url \"https://github.com/MikAoJk/git-profiles-cli/releases/download/v.*/git-profiles-cli-.*-aarch64-apple-darwin.tar.gz\"|url \"https://github.com/MikAoJk/git-profiles-cli/releases/download/v${{ github.event.inputs.version }}/git-profiles-cli-${{ github.event.inputs.version }}-aarch64-apple-darwin.tar.gz\"|" $FORMULA_FILE
          
          # Update SHA256 for ARM64 (first occurrence after "if Hardware::CPU.arm?")
          awk -v sha="${{ github.event.inputs.aarch64_sha256 }}" '
            /if Hardware::CPU.arm?/ { arm_section=1 }
            arm_section && /sha256/ && !arm_done { 
              sub(/sha256 ".*"/, "sha256 \"" sha "\"")
              arm_done=1
            }
            /else/ && arm_section { arm_section=0 }
            { print }
          ' $FORMULA_FILE > ${FORMULA_FILE}.tmp && mv ${FORMULA_FILE}.tmp $FORMULA_FILE
          
          # Update SHA256 for x86_64 (second occurrence, in else block)
          awk -v sha="${{ github.event.inputs.x86_64_sha256 }}" '
            /else/ { else_section=1 }
            else_section && /sha256/ && !x86_done { 
              sub(/sha256 ".*"/, "sha256 \"" sha "\"")
              x86_done=1
            }
            /end/ && else_section { else_section=0 }
            { print }
          ' $FORMULA_FILE > ${FORMULA_FILE}.tmp && mv ${FORMULA_FILE}.tmp $FORMULA_FILE

      - name: Commit and push changes
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Update git-profiles-cli to v${{ github.event.inputs.version }}"
          git push
